[tox]
min_version = 4.0
env_list =
    black
    docs
    notebooks_doctests
;    opt-slow
    py38
    py39-upstream-doctest
    py310-slow
requires =
    pip >= 21.0
opts = -vv

[testenv:black]
description = Run code quality compliance tests under {basepython}
skip_install = True
extras =
deps =
    flake8
    flake8-rst-docstrings
    black[jupyter]
    blackdoc
    isort
    nbqa
    pydocstyle
    yamllint
commands_pre =
commands =
    pydocstyle --config=setup.cfg xclim
    flake8 --config=setup.cfg xclim
    black --check xclim
    nbqa black --check docs
    blackdoc --check --exclude=xclim/indices/__init__.py xclim
    blackdoc --check docs
    isort --check xclim
    yamllint --config-file=.yamllint.yaml xclim
commands_post =

[testenv:docs]
description = Build the documentation with makefile under {basepython}
setenv =
    !notebooks: SKIP_NOTEBOOKS = 1
    PYTHONPATH = {toxinidir}
    READTHEDOCS = 1
commands_pre =
commands =
    make docs
commands_post =
allowlist_externals =
    env
    make

# Requires tox-conda compatible with tox@v4.0
;[testenv:conda]
;description = Run tests with pytest under {basepython} (Anaconda distribution)
;conda_channels = conda-forge
;conda_env = environment-dev.yml
;extras =

[testenv:notebooks_doctests{-coverage,}]
description = Run notebooks and doctests with pytest under {basepython}
commands =
    pytest --no-cov --nbval --dist=loadscope docs/notebooks --ignore=docs/notebooks/example.ipynb
    pytest --rootdir xclim/testing/tests/ --xdoctest xclim --ignore=xclim/testing/tests/

# Requires tox-conda compatible with tox@v4.0
;[testenv:opt-{slow,not_slow}]
;description = Run tests with optional requirements (SBCK (experimental), eofs) and pytest under {basepython} (Anaconda distribution)
;conda_env = environment-dev.yml
;commands =
;    pip check
;    !slow: pytest xclim -m "not slow" --durations=10
;    slow: pytest xclim --durations=10

[testenv]
description = Run tests with pytest under {basepython}
setenv =
    COV_CORE_SOURCE =
    PYTEST_ADDOPTS = --numprocesses=logical --durations=10
    coverage: PYTEST_ADDOPTS = --numprocesses=logical --durations=10 --cov=xclim --cov-report=term-missing
    PYTHONPATH = {toxinidir}
passenv =
    CI
    CONDA_EXE
    COVERALLS_*
    GITHUB_*
    LD_LIBRARY_PATH
    XCLIM_*
extras = dev
deps =
    py38: scipy<1.9
    coverage: coveralls
    upstream: -rrequirements_upstream.txt
    eofs: eofs
    sbck: pybind11
    sbck: sbck @ git+https://github.com/yrobink/SBCK-python.git@master
install_command = python -m pip install --no-user {opts} {packages}
download = True
commands_pre =
    python -m pip list
    python -m pip check
commands =
    doctest: pytest --no-cov --rootdir xclim/testing/tests/ --xdoctest xclim --ignore=xclim/testing/tests/
    !slow: pytest xclim -m "not slow"
    slow: pytest xclim
commands_post =
    coverage: - coveralls
allowlist_externals =
    git
